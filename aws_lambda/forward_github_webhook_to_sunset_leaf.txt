import hashlib, hmac, httplib, json, urllib


def get_required_stage_variable(event, stage_variable_name):

    if not stage_variable_name in event:
        raise Exception("The caller must specify the '" + stage_variable_name + "' parameter in the API-gateway's integration-request's mapping-templates.")
    
    return event[stage_variable_name]


def webhook_handler(event, context):
    
    github_secret = get_required_stage_variable(event, 'github_secret')
    particle_access_token = get_required_stage_variable(event, 'particle_access_token')
    
    request_querystring = urllib.urlencode({
        'access_token': particle_access_token,
        })
        
    request_headers = {
        "content-type": "application/json",
        "accept": "text/plain"}
    
    request_body = json.dumps({
        'name': 'web_alert',
        'data': 'github_activity',
        'private': 'false'
        })
    
    print "request_body"
    print request_body, '\n'
    
    connection = httplib.HTTPSConnection("api.particle.io")
    
    connection.request(
        "POST",
        "/v1/devices/events?%s" % request_querystring,
        request_body,
        request_headers)
        
    response = connection.getresponse()
    
    print "response_code"
    print response.status, response.reason, '\n'

    response_data = response.read()
    
    print "response_data"
    print response_data, '\n'
    
    connection.close()